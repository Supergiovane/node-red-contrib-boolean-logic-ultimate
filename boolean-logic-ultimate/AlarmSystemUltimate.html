<script type="text/javascript">
  RED.nodes.registerType('AlarmSystemUltimate', {
    category: 'Boolean Logic Ultimate',
    color: '#ff8080',
    defaults: {
      name: { value: '' },
      controlTopic: { value: 'alarm' },
      payloadPropName: { value: 'payload', required: false },
      translatorConfig: { type: 'translator-config', required: false },
      persistState: { value: true },
      requireCodeForArm: { value: false },
      requireCodeForDisarm: { value: true },
      armCode: { value: '' },
      duressCode: { value: '' },
      blockArmOnViolations: { value: true },
      exitDelaySeconds: { value: 30, validate: RED.validators.number() },
      entryDelaySeconds: { value: 30, validate: RED.validators.number() },
      sirenDurationSeconds: { value: 180, validate: RED.validators.number() },
      sirenLatchUntilDisarm: { value: false },
      sirenTopic: { value: 'siren' },
      sirenOnPayload: { value: true },
      sirenOnPayloadType: { value: 'bool' },
      sirenOffPayload: { value: false },
      sirenOffPayloadType: { value: 'bool' },
      emitRestoreEvents: { value: false },
      maxLogEntries: { value: 50, validate: RED.validators.number() },
      zones: { value: '' }
    },
    inputs: 1,
    outputs: 2,
    outputLabels: ['Events', 'Siren'],
    icon: 'alert.png',
    label: function () {
      return this.name || 'Alarm System (BETA)';
    },
    paletteLabel: function () {
      return 'Alarm System (BETA)';
    },
    oneditprepare: function () {
      const payloadField = $('#node-input-payloadPropName');
      if (payloadField.val() === '') payloadField.val('payload');
      payloadField.typedInput({ default: 'msg', types: ['msg'] });

      $('#node-input-sirenOnPayload').typedInput({
        default: this.sirenOnPayloadType || 'bool',
        types: ['str', 'num', 'bool', 'json', 'date']
      });
      $('#node-input-sirenOnPayload').typedInput('type', this.sirenOnPayloadType || 'bool');

      $('#node-input-sirenOffPayload').typedInput({
        default: this.sirenOffPayloadType || 'bool',
        types: ['str', 'num', 'bool', 'json', 'date']
      });
      $('#node-input-sirenOffPayload').typedInput('type', this.sirenOffPayloadType || 'bool');

      const zonesField = $('#node-input-zones');
      zonesField.css('font-family', 'monospace');

      function parseZonesText(text) {
        const raw = String(text || '').trim();
        if (!raw) return [];

        try {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) {
            return parsed.filter((z) => z && typeof z === 'object');
          }
          if (parsed && typeof parsed === 'object') {
            return [parsed];
          }
        } catch (err) {
          // fallthrough to JSON-per-line
        }

        const zones = [];
        const lines = raw.split('\n');
        for (let index = 0; index < lines.length; index += 1) {
          const line = String(lines[index] || '').trim();
          if (!line) continue;
          try {
            const parsed = JSON.parse(line);
            if (parsed && typeof parsed === 'object') {
              zones.push(parsed);
            }
          } catch (err) {
            throw new Error(`Invalid JSON at line ${index + 1}`);
          }
        }
        return zones;
      }

      $('#node-input-zones-format').on('click', function (evt) {
        evt.preventDefault();
        try {
          const zones = parseZonesText(zonesField.val());
          zonesField.val(zones.length ? JSON.stringify(zones, null, 2) : '');
        } catch (err) {
          RED.notify(`Zones: ${err.message}`, 'error');
        }
      });

      $('#node-input-zones-legacy').on('click', function (evt) {
        evt.preventDefault();
        try {
          const zones = parseZonesText(zonesField.val());
          const legacy = zones
            .map((zone) => JSON.stringify(zone))
            .filter((line) => line !== undefined && line !== null && line !== '')
            .join('\n');
          zonesField.val(legacy);
        } catch (err) {
          RED.notify(`Zones: ${err.message}`, 'error');
        }
      });
    },
    oneditsave: function () {
      this.sirenOnPayloadType = $('#node-input-sirenOnPayload').typedInput('type');
      this.sirenOffPayloadType = $('#node-input-sirenOffPayload').typedInput('type');
    }
  });
</script>

<script type="text/html" data-template-name="AlarmSystemUltimate">
  <div class="form-row">
    <b>Alarm System Ultimate (BETA)</b>
    &nbsp;&nbsp;<span style="color:red"><i class="fa fa-question-circle"></i>&nbsp;<a target="_blank" href="https://github.com/Supergiovane/node-red-contrib-boolean-logic-ultimate"><u>Help online</u></a></span>
  </div>

  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label for="node-input-controlTopic"><i class="fa fa-tag"></i> Control topic</label>
    <input type="text" id="node-input-controlTopic">
  </div>

  <div class="form-row">
    <label for="node-input-payloadPropName"><i class="fa fa-ellipsis-h"></i> With Input</label>
    <input type="text" id="node-input-payloadPropName">
  </div>

  <div class="form-row">
    <label for="node-input-translatorConfig"><i class="fa fa-language"></i> Translator</label>
    <input type="text" id="node-input-translatorConfig">
  </div>

  <div class="form-row">
    <label for="node-input-persistState"><i class="fa fa-database"></i> Persist state</label>
    <input type="checkbox" id="node-input-persistState" style="width:auto; margin-top:7px;">
  </div>

  <hr/>

  <div class="form-row">
    <label for="node-input-requireCodeForArm"><i class="fa fa-lock"></i> Require code for arm</label>
    <input type="checkbox" id="node-input-requireCodeForArm" style="width:auto; margin-top:7px;">
  </div>

  <div class="form-row">
    <label for="node-input-requireCodeForDisarm"><i class="fa fa-unlock"></i> Require code for disarm</label>
    <input type="checkbox" id="node-input-requireCodeForDisarm" style="width:auto; margin-top:7px;">
  </div>

  <div class="form-row">
    <label for="node-input-armCode"><i class="fa fa-key"></i> Code</label>
    <input type="password" id="node-input-armCode" placeholder="(optional)">
  </div>

  <div class="form-row">
    <label for="node-input-duressCode"><i class="fa fa-user-secret"></i> Duress code</label>
    <input type="password" id="node-input-duressCode" placeholder="(optional)">
  </div>

  <div class="form-row">
    <label for="node-input-blockArmOnViolations"><i class="fa fa-shield"></i> Block arm on violations</label>
    <input type="checkbox" id="node-input-blockArmOnViolations" style="width:auto; margin-top:7px;">
  </div>

  <hr/>

  <div class="form-row">
    <label for="node-input-exitDelaySeconds"><i class="fa fa-sign-out"></i> Exit delay (s)</label>
    <input type="number" id="node-input-exitDelaySeconds" min="0">
  </div>

  <div class="form-row">
    <label for="node-input-entryDelaySeconds"><i class="fa fa-sign-in"></i> Entry delay (s)</label>
    <input type="number" id="node-input-entryDelaySeconds" min="0">
  </div>

  <hr/>

  <div class="form-row">
    <label for="node-input-sirenTopic"><i class="fa fa-bullhorn"></i> Siren topic</label>
    <input type="text" id="node-input-sirenTopic" placeholder="siren">
  </div>

  <div class="form-row">
    <label for="node-input-sirenDurationSeconds"><i class="fa fa-clock-o"></i> Siren duration (s)</label>
    <input type="number" id="node-input-sirenDurationSeconds" min="0">
  </div>

  <div class="form-row">
    <label for="node-input-sirenLatchUntilDisarm"><i class="fa fa-link"></i> Latch siren until disarm</label>
    <input type="checkbox" id="node-input-sirenLatchUntilDisarm" style="width:auto; margin-top:7px;">
  </div>

  <div class="form-row">
    <label for="node-input-sirenOnPayload"><i class="fa fa-play"></i> Siren ON payload</label>
    <input type="text" id="node-input-sirenOnPayload">
  </div>

  <div class="form-row">
    <label for="node-input-sirenOffPayload"><i class="fa fa-stop"></i> Siren OFF payload</label>
    <input type="text" id="node-input-sirenOffPayload">
  </div>

  <hr/>

  <div class="form-row">
    <label for="node-input-emitRestoreEvents"><i class="fa fa-undo"></i> Emit restore events</label>
    <input type="checkbox" id="node-input-emitRestoreEvents" style="width:auto; margin-top:7px;">
  </div>

  <div class="form-row">
    <label for="node-input-maxLogEntries"><i class="fa fa-list"></i> Event log size</label>
    <input type="number" id="node-input-maxLogEntries" min="0" max="500">
  </div>

  <div class="form-row">
    <label for="node-input-zones"><i class="fa fa-th-large"></i> Zones (JSON per line or JSON array)</label>
    <textarea id="node-input-zones" spellcheck="false" wrap="off" style="width:100%; height:220px; font-family:monospace;"
      placeholder='{"id":"front_door","name":"Front door","topic":"sensor/frontdoor","type":"perimeter","entry":true,"modes":["away","home","night"],"bypassable":true,"chime":true}\n{"id":"pir_living","name":"Living PIR","topic":"sensor/living_pir","type":"motion","modes":["away"],"entry":false,"bypassable":true,"cooldownSeconds":10}'></textarea>
  </div>

  <div class="form-row">
    <label>&nbsp;</label>
    <button type="button" class="red-ui-button" id="node-input-zones-format"><i class="fa fa-indent"></i> Format</button>
    <button type="button" class="red-ui-button" id="node-input-zones-legacy" style="margin-left:5px;"><i class="fa fa-list"></i> Legacy</button>
  </div>
</script>

<script type="text/markdown" data-help-name="AlarmSystemUltimate">
<p><b>BETA</b> – Alarm control panel node with multi-mode arming, zones, entry/exit delays, bypass, chime, tamper/fire/24h zones, siren control, status and event log.</p>

The node has 2 inputs "in one":

- **Control messages**: when `msg.topic` equals **Control topic**.
- **Sensor messages**: any other message, matched to a zone by `msg.topic` and converted to boolean using **With Input** (default `payload`) and the optional **Translator**.

<br/>

|Property|Description|
|--|--|
| Control topic | Topic that receives runtime commands (arm/disarm/status/bypass/siren/panic/reset). |
| With Input | Message property evaluated as sensor value (default `payload`). |
| Translator | Optional translator-config for true/false conversion (useful for Home Assistant strings). |
| Persist state | Persists arming mode, bypass list and event log across restarts. |
| Require code for arm | Requires a valid PIN for arming commands (via `msg.code` or `msg.pin`). If **Code** is empty, commands are allowed. |
| Require code for disarm | Requires a valid PIN for disarming commands (via `msg.code` or `msg.pin`). If **Code** is empty, commands are allowed. |
| Code | PIN required to arm/disarm when enabled. |
| Duress code | If provided and `msg.code` matches, the node raises a silent duress alarm while still executing the command. |
| Block arm on violations | Prevents arming if any active (true) zone would be armed (excluding bypassed zones). Checked both at arm start and after exit delay. |
| Exit/Entry delay (s) | Global exit/entry delays (each zone can override entry delay). |
| Siren topic | Topic used on output 2 to turn the siren on/off (default: `controlTopic + "/siren"`). |
| Siren ON/OFF payload | Values emitted on output 2 for siren on/off (typed). |
| Siren duration (s) | Auto stop duration (`0` = latch until disarm). |
| Latch siren until disarm | Forces siren to remain on until disarm (ignores duration). |
| Emit restore events | Emits `zone_restore` when a zone returns to false. |
| Event log size | Max stored log entries in node context (0 disables log). |
| Zones | Zone definitions. Supports legacy "one JSON object per line" or a JSON array (use **Format** / **Legacy** buttons). |

<br/>

## Outputs

**Output 1 (Events)**

- `msg.topic = controlTopic + "/event"`
- `msg.event` (string) and `msg.payload` (object)

`msg.payload` always contains at least:

- `event`: same as `msg.event`
- `mode`: `disarmed|away|home|night`

**Output 2 (Siren)**

- `msg.topic = sirenTopic`
- `msg.payload`: configured siren ON/OFF payload (typed)
- `msg.event`: `siren_on` / `siren_off`
- `msg.reason`: why it changed (`manual`, `panic`, `instant`, `entry_timeout`, `timeout`, `disarm`, ...)

<br/>

## Events (`msg.event`)

Arming / state:

- `arming` → `{ mode, seconds, reason }`
- `armed` → `{ mode, reason }`
- `disarmed` → `{ reason, duress }`
- `already_armed` → `{ mode }`
- `arm_blocked` → `{ mode, violations:[{id,name,type}] }`
- `status` → `{ state: { mode, arming, entry, alarmActive, silentAlarmActive, sirenActive, alarmZone, bypassedZones, log } }`
- `reset` → `{}`
- `denied` → `{ action: "arm"|"disarm", mode? }`
- `error` → `{ error: "missing_zone"|"unknown_zone"|"zone_not_bypassable", zone? }`

Zones / alarm:

- `entry_delay` → `{ zone:{id,name}, seconds }`
- `alarm` → `{ kind, zone, silent }` where `kind` can be `instant|entry_timeout|panic|duress|fire|tamper|24h|...`
- `chime` → `{ zone:{id,name,type} }` (while disarmed)
- `zone_ignored_exit` → `{ zone:{id,name,type} }` (triggered during exit delay and not allowed)
- `zone_bypassed_trigger` → `{ zone:{id,name,type} }`
- `zone_restore` → `{ zone:{id,name,type} }` (when enabled)
- `siren_on` → `{ reason }` (manual `siren_on` command)
- `siren_off` → `{ reason }` (manual stop, disarm, timeout, arm, ...)

<br/>

## Control messages (`msg.topic === controlTopic`)

Arm:

- `msg.command = "arm_away"|"arm_home"|"arm_night"`
- or `msg.arm = "away"|"home"|"night"`
- or `msg.mode = "away"|"home"|"night"`

Disarm:

- `msg.command = "disarm"` or `msg.disarm = true`

Status snapshot:

- `msg.command = "status"` or `msg.status = true`

Bypass / unbypass (zone id):

- `msg.command = "bypass"` / `msg.command = "unbypass"`
- or `msg.bypass = true` / `msg.unbypass = true`
- pass the zone id in `msg.zone` (alias: `msg.zoneId`, `msg.zoneName` - still expects the zone `id`)

Siren:

- `msg.command = "siren_on"|"siren_off"`

Panic:

- `msg.command = "panic"` (audible)
- `msg.command = "panic_silent"` (silent)

Reset:

- `msg.command = "reset"` or `msg.reset = true` (clears mode, bypass list, log and timers)

Codes:

- pass `msg.code` (or `msg.pin`) when code checks are enabled
- if `msg.code` equals **Duress code**, the node emits a silent duress alarm while still arming/disarming

<br/>

## Zones

Zones can be configured as:

- **Legacy**: one JSON object per line
- **Formatted**: a JSON array of objects

Minimal fields:

- `topic` (exact topic, or a prefix ending with `*`) OR `topicPattern` (regex string)
- `topicPattern` is evaluated as a JavaScript `RegExp` and tested against `msg.topic`
- `id` is optional (auto-generated if missing)

Common fields:

- `id`: unique identifier used for bypass (`msg.zone`)
- `name`: label used in events
- `type`: `perimeter` (default), `motion`, `tamper`, `fire`, `24h`
- `modes`: `["away","home","night"]` (empty = active in all armed modes)
- `entry`: `true` to use entry delay, otherwise triggers instantly
- `entryDelaySeconds`: overrides the global entry delay
- `bypassable`: `true|false` (default `true`)
- `chime`: `true` to emit `chime` event while disarmed
- `cooldownSeconds`: minimum time between triggers
- `instantDuringExit`: if true, the zone can trigger during exit delay

Notes:

- `tamper`, `fire` and `24h` zones are considered **always active** (they can alarm even while disarmed).
- If a zone is bypassed, triggers generate `zone_bypassed_trigger` and do not alarm.

Example (formatted JSON array):

```json
[
  {
    "id": "front_door",
    "name": "Front door",
    "topic": "house/door/front",
    "type": "perimeter",
    "modes": ["away", "night"],
    "entry": true,
    "entryDelaySeconds": 30,
    "bypassable": true,
    "chime": true
  }
]
```

<br/>

[SEE THE README FOR FULL HELP AND SAMPLES](https://github.com/Supergiovane/node-red-contrib-boolean-logic-ultimate)</br>

[Find it useful?](https://www.paypal.me/techtoday)
</script>
