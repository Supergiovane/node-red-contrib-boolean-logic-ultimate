<script type="text/javascript">
  RED.nodes.registerType('AlarmSystemUltimate', {
    category: 'Boolean Logic Ultimate',
    color: '#ff8080',
    defaults: {
      name: { value: '' },
      controlTopic: { value: 'alarm' },
      payloadPropName: { value: 'payload', required: false },
      translatorConfig: { type: 'translator-config', required: false },
      persistState: { value: true },
      requireCodeForArm: { value: false },
      requireCodeForDisarm: { value: true },
      armCode: { value: '' },
      duressCode: { value: '' },
      blockArmOnViolations: { value: true },
      exitDelaySeconds: { value: 30, validate: RED.validators.number() },
      entryDelaySeconds: { value: 30, validate: RED.validators.number() },
      sirenDurationSeconds: { value: 180, validate: RED.validators.number() },
      sirenLatchUntilDisarm: { value: false },
      sirenTopic: { value: 'siren' },
      sirenOnPayload: { value: true },
      sirenOnPayloadType: { value: 'bool' },
      sirenOffPayload: { value: false },
      sirenOffPayloadType: { value: 'bool' },
      emitRestoreEvents: { value: false },
      maxLogEntries: { value: 50, validate: RED.validators.number() },
      zones: { value: '' }
    },
    inputs: 1,
    outputs: 2,
    outputLabels: ['Events', 'Siren'],
    icon: 'alert.png',
    label: function () {
      return this.name || 'Alarm System (BETA)';
    },
    paletteLabel: function () {
      return 'Alarm System (BETA)';
    },
    oneditprepare: function () {
      const payloadField = $('#node-input-payloadPropName');
      if (payloadField.val() === '') payloadField.val('payload');
      payloadField.typedInput({ default: 'msg', types: ['msg'] });

      $('#node-input-sirenOnPayload').typedInput({
        default: this.sirenOnPayloadType || 'bool',
        types: ['str', 'num', 'bool', 'json', 'date']
      });
      $('#node-input-sirenOnPayload').typedInput('type', this.sirenOnPayloadType || 'bool');

      $('#node-input-sirenOffPayload').typedInput({
        default: this.sirenOffPayloadType || 'bool',
        types: ['str', 'num', 'bool', 'json', 'date']
      });
      $('#node-input-sirenOffPayload').typedInput('type', this.sirenOffPayloadType || 'bool');

      const zonesField = $('#node-input-zones');
      zonesField.css('font-family', 'monospace');

      function parseZonesText(text) {
        const raw = String(text || '').trim();
        if (!raw) return [];

        try {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) {
            return parsed.filter((z) => z && typeof z === 'object');
          }
          if (parsed && typeof parsed === 'object') {
            return [parsed];
          }
        } catch (err) {
          // fallthrough to JSON-per-line
        }

        const zones = [];
        const lines = raw.split('\n');
        for (let index = 0; index < lines.length; index += 1) {
          const line = String(lines[index] || '').trim();
          if (!line) continue;
          try {
            const parsed = JSON.parse(line);
            if (parsed && typeof parsed === 'object') {
              zones.push(parsed);
            }
          } catch (err) {
            throw new Error(`Invalid JSON at line ${index + 1}`);
          }
        }
        return zones;
      }

      $('#node-input-zones-format').on('click', function (evt) {
        evt.preventDefault();
        try {
          const zones = parseZonesText(zonesField.val());
          zonesField.val(zones.length ? JSON.stringify(zones, null, 2) : '');
        } catch (err) {
          RED.notify(`Zones: ${err.message}`, 'error');
        }
      });
    },
    oneditsave: function () {
      this.sirenOnPayloadType = $('#node-input-sirenOnPayload').typedInput('type');
      this.sirenOffPayloadType = $('#node-input-sirenOffPayload').typedInput('type');
    }
  });
</script>

<script type="text/html" data-template-name="AlarmSystemUltimate">
  <div class="form-row">
    <b>Alarm System Ultimate (BETA)</b>
    &nbsp;&nbsp;<span style="color:red"><i class="fa fa-question-circle"></i>&nbsp;<a target="_blank" href="https://github.com/Supergiovane/node-red-contrib-boolean-logic-ultimate"><u>Help online</u></a></span>
  </div>

  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label for="node-input-controlTopic"><i class="fa fa-tag"></i> Control topic</label>
    <input type="text" id="node-input-controlTopic">
  </div>

  <div class="form-row">
    <label for="node-input-payloadPropName"><i class="fa fa-ellipsis-h"></i> With Input</label>
    <input type="text" id="node-input-payloadPropName">
  </div>

  <div class="form-row">
    <label for="node-input-translatorConfig"><i class="fa fa-language"></i> Translator</label>
    <input type="text" id="node-input-translatorConfig">
  </div>

  <div class="form-row">
    <label for="node-input-persistState"><i class="fa fa-database"></i> Persist state</label>
    <input type="checkbox" id="node-input-persistState" style="width:auto; margin-top:7px;">
  </div>

  <hr/>

  <div class="form-row">
    <label for="node-input-requireCodeForArm"><i class="fa fa-lock"></i> Require code for arm</label>
    <input type="checkbox" id="node-input-requireCodeForArm" style="width:auto; margin-top:7px;">
  </div>

  <div class="form-row">
    <label for="node-input-requireCodeForDisarm"><i class="fa fa-unlock"></i> Require code for disarm</label>
    <input type="checkbox" id="node-input-requireCodeForDisarm" style="width:auto; margin-top:7px;">
  </div>

  <div class="form-row">
    <label for="node-input-armCode"><i class="fa fa-key"></i> Code</label>
    <input type="password" id="node-input-armCode" placeholder="(optional)">
  </div>

  <div class="form-row">
    <label for="node-input-duressCode"><i class="fa fa-user-secret"></i> Duress code</label>
    <input type="password" id="node-input-duressCode" placeholder="(optional)">
  </div>

  <div class="form-row">
    <label for="node-input-blockArmOnViolations"><i class="fa fa-shield"></i> Block arm on violations</label>
    <input type="checkbox" id="node-input-blockArmOnViolations" style="width:auto; margin-top:7px;">
  </div>

  <hr/>

  <div class="form-row">
    <label for="node-input-exitDelaySeconds"><i class="fa fa-sign-out"></i> Exit delay (s)</label>
    <input type="number" id="node-input-exitDelaySeconds" min="0">
  </div>

  <div class="form-row">
    <label for="node-input-entryDelaySeconds"><i class="fa fa-sign-in"></i> Entry delay (s)</label>
    <input type="number" id="node-input-entryDelaySeconds" min="0">
  </div>

  <hr/>

  <div class="form-row">
    <label for="node-input-sirenTopic"><i class="fa fa-bullhorn"></i> Siren topic</label>
    <input type="text" id="node-input-sirenTopic" placeholder="siren">
  </div>

  <div class="form-row">
    <label for="node-input-sirenDurationSeconds"><i class="fa fa-clock-o"></i> Siren duration (s)</label>
    <input type="number" id="node-input-sirenDurationSeconds" min="0">
  </div>

  <div class="form-row">
    <label for="node-input-sirenLatchUntilDisarm"><i class="fa fa-link"></i> Latch siren until disarm</label>
    <input type="checkbox" id="node-input-sirenLatchUntilDisarm" style="width:auto; margin-top:7px;">
  </div>

  <div class="form-row">
    <label for="node-input-sirenOnPayload"><i class="fa fa-play"></i> Siren ON payload</label>
    <input type="text" id="node-input-sirenOnPayload">
  </div>

  <div class="form-row">
    <label for="node-input-sirenOffPayload"><i class="fa fa-stop"></i> Siren OFF payload</label>
    <input type="text" id="node-input-sirenOffPayload">
  </div>

  <hr/>

  <div class="form-row">
    <label for="node-input-emitRestoreEvents"><i class="fa fa-undo"></i> Emit restore events</label>
    <input type="checkbox" id="node-input-emitRestoreEvents" style="width:auto; margin-top:7px;">
  </div>

  <div class="form-row">
    <label for="node-input-maxLogEntries"><i class="fa fa-list"></i> Event log size</label>
    <input type="number" id="node-input-maxLogEntries" min="0" max="500">
  </div>

  <div class="form-row">
    <label for="node-input-zones"><i class="fa fa-th-large"></i> Zones (JSON per line or JSON array)</label>
    <textarea id="node-input-zones" spellcheck="false" wrap="off" style="width:100%; height:220px; font-family:monospace;"
      placeholder='{"id":"front_door","name":"Front door","topic":"sensor/frontdoor","type":"perimeter","entry":true,"modes":["away","home","night"],"bypassable":true,"chime":true}\n{"id":"pir_living","name":"Living PIR","topic":"sensor/living_pir","type":"motion","modes":["away"],"entry":false,"bypassable":true,"cooldownSeconds":10}'></textarea>
  </div>

  <div class="form-row">
    <label>&nbsp;</label>
    <button type="button" class="red-ui-button" id="node-input-zones-format"><i class="fa fa-indent"></i> Format</button>
  </div>
</script>

<script type="text/markdown" data-help-name="AlarmSystemUltimate">
<p><b>BETA</b> â€“ This node implements an alarm control panel with advanced features: multi-mode arming, zones, entry/exit delays, bypass, tamper/fire 24h zones, siren control, status and event log.</p>

**Outputs**

- Output 1 (Events): emits `msg.event` and `msg.payload` describing state changes.
- Output 2 (Siren): emits siren on/off commands using the configured topic and payloads.

**Zones**

Configure zones as one JSON object per line (legacy) or as a JSON array of objects. Minimal fields:

- `id` (string, optional)
- `name` (string, optional)
- `topic` (string) OR `topicPattern` (regex string)

Useful fields:

- `type`: `perimeter` (default), `motion`, `tamper`, `fire`, `24h`
- `modes`: `["away","home","night"]` (empty = active in all armed modes)
- `entry`: `true` to use entry delay, otherwise triggers instantly
- `entryDelaySeconds`: overrides the global entry delay
- `bypassable`: `true|false`
- `chime`: `true` to emit chime event while disarmed
- `cooldownSeconds`: minimum time between triggers
- `instantDuringExit`: if true, the zone can trigger during exit delay

**Control topic commands** (when `msg.topic` equals the *Control topic*)

- Arm: `msg.command = "arm_away"|"arm_home"|"arm_night"` or `msg.arm = "away"|"home"|"night"`
- Disarm: `msg.command = "disarm"` or `msg.disarm = true`
- Status: `msg.command = "status"` or `msg.status = true`
- Bypass: `msg.command = "bypass"` / `msg.command = "unbypass"` with `msg.zone = "<zone id>"`
- Panic: `msg.command = "panic"` or `msg.command = "panic_silent"`
- Siren: `msg.command = "siren_on"|"siren_off"`
- Reset (clears state and bypass): `msg.command = "reset"` or `msg.reset = true`

When codes are enabled, pass `msg.code` (or `msg.pin`). If `duressCode` matches, the node raises a silent duress alarm event.

<br/>

[SEE THE README FOR FULL HELP AND SAMPLES](https://github.com/Supergiovane/node-red-contrib-boolean-logic-ultimate)</br>

[Find it useful?](https://www.paypal.me/techtoday)
</script>
